<div class="form-container">
  <div class="form-header">
    <h2>Nouvelle demande</h2>
  </div>

  <form [formGroup]="derogationForm" class="derogation-form">

    <!-- Ligne 1: ID SAB + CONFIRMER, Nombre de comptes, Nom, Prénom -->
    <div class="form-grid">
      <div class="form-field">
        <label>ID SAB <span class="required">*</span></label>
        <div class="input-with-button">
          <input
            type="text"
            formControlName="idSab"
            placeholder="Zone de texte"
            [class.error]="isFieldInvalid('idSab')">
          <button
            type="button"
            class="btn-confirm-inside"
            (click)="onValidateIdSab()"
            [disabled]="isValidatingIdSab || isIdSabValidated"
            [class.validated]="isIdSabValidated">
            {{ isValidatingIdSab ? 'VALIDATION...' : (isIdSabValidated ? 'VALIDÉ' : 'CONFIRMER') }}
          </button>
        </div>
        <div class="error-message" *ngIf="isFieldInvalid('idSab')">
          {{ getFieldError('idSab') }}
        </div>
      </div>

      <div class="form-field">
        <label>Nombre de comptes</label>
        <input
          type="number"
          formControlName="nombreComptes"
          placeholder="Zone de texte"
          [readonly]="!isIdSabValidated">
      </div>

      <div class="form-field">
        <label>Nom <span class="required">*</span></label>
        <input
          type="text"
          formControlName="nom"
          placeholder="Zone de texte"
          [class.error]="isFieldInvalid('nom')"
          [readonly]="!isIdSabValidated">
        <div class="error-message" *ngIf="isFieldInvalid('nom')">
          {{ getFieldError('nom') }}
        </div>
      </div>

      <div class="form-field">
        <label>Prénom <span class="required">*</span></label>
        <input
          type="text"
          formControlName="prenom"
          placeholder="Zone de texte"
          [class.error]="isFieldInvalid('prenom')"
          [readonly]="!isIdSabValidated">
        <div class="error-message" *ngIf="isFieldInvalid('prenom')">
          {{ getFieldError('prenom') }}
        </div>
      </div>
    </div>

    <!-- Ligne 2: Business Line, Segment, Type de dérogation, Code commercial -->
    <div class="form-grid">
      <div class="form-field">
        <label>Business Line <span class="required">*</span></label>
        <select formControlName="businessLine" [class.error]="isFieldInvalid('businessLine')">
          <option value="">Choisissez</option>
          <option *ngFor="let option of businessLines" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
        <div class="error-message" *ngIf="isFieldInvalid('businessLine')">
          {{ getFieldError('businessLine') }}
        </div>
      </div>

      <div class="form-field">
        <label>Segment <span class="required">*</span></label>
        <select formControlName="segment" [class.error]="isFieldInvalid('segment')">
          <option value="">Choisissez</option>
          <option *ngFor="let option of segments" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
        <div class="error-message" *ngIf="isFieldInvalid('segment')">
          {{ getFieldError('segment') }}
        </div>
      </div>

      <div class="form-field">
        <label>Type de dérogation <span class="required">*</span></label>
        <select formControlName="typeDerogation" [class.error]="isFieldInvalid('typeDerogation')">
          <option value="">Choisissez</option>
          <option *ngFor="let option of typesDerogation" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
        <div class="error-message" *ngIf="isFieldInvalid('typeDerogation')">
          {{ getFieldError('typeDerogation') }}
        </div>
      </div>

      <div class="form-field">
        <label>Code commercial</label>
        <input type="text" formControlName="codeCommercial" placeholder="Zone de texte">
      </div>
    </div>

    <!-- Ligne 3: Justification standard, Devise, Date d'effet, Date de fin -->
    <div class="form-grid">
      <div class="form-field">
        <label>Justification standard</label>
        <input type="text" formControlName="justificationStandard" placeholder="Zone de texte">
      </div>

      <div class="form-field">
        <label>Devise <span class="required">*</span></label>
        <select formControlName="devise" [class.error]="isFieldInvalid('devise')">
          <option value="">Choisissez</option>
          <option *ngFor="let option of devises" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
        <div class="error-message" *ngIf="isFieldInvalid('devise')">
          {{ getFieldError('devise') }}
        </div>
      </div>

      <div class="form-field">
        <label>Date d'effet <span class="required">*</span></label>
        <input
          type="date"
          formControlName="dateEffet"
          placeholder="jj/mm/aaaa"
          [class.error]="isFieldInvalid('dateEffet')">
        <div class="error-message" *ngIf="isFieldInvalid('dateEffet')">
          {{ getFieldError('dateEffet') }}
        </div>
      </div>

      <div class="form-field">
        <label>Date de fin <span class="required">*</span></label>
        <input
          type="date"
          formControlName="dateFin"
          placeholder="jj/mm/aaaa"
          [class.error]="isFieldInvalid('dateFin')">
        <div class="error-message" *ngIf="isFieldInvalid('dateFin')">
          {{ getFieldError('dateFin') }}
        </div>
      </div>
    </div>

    <!-- Ligne 4: Taux/Montant, Tiers, Convention, Employeur -->
    <div class="form-grid">
      <div class="form-field">
        <label>Taux / Montant de la dérogation <span class="required">*</span></label>
        <input
          type="text"
          formControlName="tauxMontantDerogation"
          placeholder="Zone de texte"
          [class.error]="isFieldInvalid('tauxMontantDerogation')">
        <div class="error-message" *ngIf="isFieldInvalid('tauxMontantDerogation')">
          {{ getFieldError('tauxMontantDerogation') }}
        </div>
      </div>

      <div class="form-field">
        <label>Tiers</label>
        <input type="text" formControlName="tiers" placeholder="Zone de texte">
      </div>

      <div class="form-field">
        <label>Convention</label>
        <input type="text" formControlName="convention" placeholder="Zone de texte">
      </div>

      <div class="form-field">
        <label>Employeur</label>
        <input type="text" formControlName="employeur" placeholder="Zone de texte">
      </div>
    </div>

    <!-- Ligne 5: Salaire, FNB, (vides) -->
    <div class="form-grid">
      <div class="form-field">
        <label>Salaire</label>
        <input type="number" formControlName="salaire" placeholder="Zone de texte">
      </div>

      <div class="form-field">
        <label>FNB</label>
        <input type="text" formControlName="fnb" placeholder="Zone de texte">
      </div>

      <div class="form-field">
        <!-- Champ vide pour alignement -->
      </div>

      <div class="form-field">
        <!-- Champ vide pour alignement -->
      </div>
    </div>

    <!-- Ligne 6: Commentaire et Documents côte à côte -->
    <div class="form-grid form-grid-split">
      <div class="form-field form-field-comment">
        <label>Commentaire</label>
        <textarea
          formControlName="commentaire"
          placeholder="Zone de texte"
          rows="6">
        </textarea>
      </div>

      <div class="form-field form-field-documents">
        <label>Document(s)</label>
        <div class="file-upload-area">
          <!-- Fichiers uploadés -->
          <div class="uploaded-files" *ngIf="uploadedFiles.length > 0">
            <div class="file-item" *ngFor="let file of uploadedFiles; let i = index">
              <span class="file-badge">
                {{ file.name.toUpperCase() }}
                <button type="button" class="btn-file-remove" (click)="removeFile(i)">
                  <span class="remove-icon">✕</span>
                </button>
              </span>
            </div>
          </div>

          <!-- Espace flexible -->
          <div class="upload-spacer"></div>

          <!-- Bouton d'upload en bas à droite -->
          <div class="upload-zone">
            <input type="file" #fileInput (change)="onFileSelected($event)" multiple hidden>
            <button type="button" class="btn-upload" (click)="fileInput.click()">
              ⬆ AJOUTER UN DOCUMENT
            </button>
          </div>
        </div>
      </div>
    </div>

  </form>

  <!-- Boutons d'action -->
  <div class="form-actions">
    <button type="button" class="btn-return" (click)="onReturn()">
      RETOUR
    </button>

    <button
      type="button"
      class="btn-save-exit"
      (click)="onSaveAndExit()"
      [disabled]="isSavingDraft">
      {{ isSavingDraft ? 'SAUVEGARDE...' : 'ENREGISTRER ET QUITTER' }}
    </button>

    <button
      type="button"
      class="btn-submit"
      (click)="onSubmit()"
      [disabled]="isSubmitting || !isIdSabValidated">
      {{ isSubmitting ? 'SOUMISSION...' : 'SOUMETTRE' }}
    </button>
  </div>
</div>
